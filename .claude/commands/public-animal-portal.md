# /public-animal-portal - Create Public Animal List with Role-Based Routing

## Command
`/public-animal-portal`

## Purpose
Implement a public-facing animal list page for visitors, students, and parents with role-based routing that directs different user types to appropriate landing pages after login.

## Context
Currently, all users are directed to the admin dashboard after login. Visitors, students, and parents need a friendly, non-administrative interface to browse animals and start chat sessions. This solution creates a public animal portal and implements role-based routing.

## Sequential Reasoning Approach

### Phase 1: Analyze Current State
1. Identify existing role system in authentication
2. Map current login flow and redirect logic
3. Document existing animal display components
4. Review current routing structure

### Phase 2: Design Public Interface
1. Create user-friendly animal list page
2. Design mobile-responsive animal cards
3. Implement "View Details" and "Chat" buttons
4. Remove admin controls for public view

### Phase 3: Implement Role-Based Routing
1. Detect user role from JWT token or user data
2. Create routing logic based on role
3. Implement proper redirects after login
4. Ensure consistent navigation experience

### Phase 4: Testing & Validation
1. Test each role type login flow
2. Verify proper page access permissions
3. Validate mobile responsiveness
4. Ensure chat integration works

## Implementation Steps

### Step 1: Create Public Animal List Component Using 21st.dev

**IMPORTANT**: Use the Magic MCP (`/ui` or `/21`) to generate this component from 21st.dev patterns for modern, accessible UI.

```bash
# Command to generate the component
/ui Create a reusable animal list page with cards showing animal name, species, habitat,
personality preview, and two action buttons: "View Details" and "Chat with Me!".
Make it mobile-responsive with a friendly, colorful design suitable for zoo visitors.
Include loading states and empty states. Use green color scheme.
```

**Component Structure** (to be generated via 21st.dev):
```typescript
// frontend/src/pages/PublicAnimalList.tsx
// This component should be generated using /ui command for best practices

import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { MessageCircle, Info, Heart, MapPin } from 'lucide-react';
// Import the reusable AnimalCard component
import { AnimalCard } from '../components/AnimalCard';

const PublicAnimalList: React.FC = () => {
  const navigate = useNavigate();
  const [animals, setAnimals] = useState([]);
  const [loading, setLoading] = useState(true);

  // Fetch only active animals
  const fetchAnimals = async () => {
    const response = await fetch('/api/animal_list');
    const data = await response.json();
    setAnimals(data.filter(a => a.status === 'active'));
    setLoading(false);
  };

  useEffect(() => {
    fetchAnimals();
  }, []);

  return (
    <div className="min-h-screen bg-gradient-to-b from-green-50 to-white">
      {/* Component generated by 21st.dev will go here */}
      {/* Should include: */}
      {/* - Friendly header with zoo branding */}
      {/* - Grid layout for animal cards */}
      {/* - Loading skeleton */}
      {/* - Empty state with illustration */}
      {/* - Mobile-optimized responsive design */}
    </div>
  );
};

export default PublicAnimalList;
```

**Reusable Animal Card Component** (separate file for reusability):
```typescript
// frontend/src/components/AnimalCard.tsx
// Generate this with: /ui Create a reusable animal card component with avatar,
// name, species, habitat, personality preview, and action buttons

export const AnimalCard = ({
  animal,
  onViewDetails,
  onStartChat,
  variant = 'public' // 'public' | 'admin' | 'compact'
}) => {
  // 21st.dev generated component with:
  // - Accessible markup
  // - Hover animations
  // - Touch-friendly buttons
  // - Progressive enhancement
  // - Skeleton loading state
};
```

### Step 2: Update Authentication with Role Detection
```typescript
// frontend/src/contexts/AuthContext.tsx
interface User {
  email: string;
  role: 'visitor' | 'student' | 'parent' | 'zookeeper' | 'admin';
  // ... other fields
}

const getUserRole = (user: any): string => {
  // Check JWT token claims or user data
  if (user.email?.includes('admin')) return 'admin';
  if (user.role) return user.role;

  // Check against known patterns
  if (user.email?.endsWith('@cmz.org')) return 'zookeeper';
  if (user.isParent) return 'parent';
  if (user.isStudent) return 'student';

  return 'visitor';
};
```

### Step 3: Implement Role-Based Routing
```typescript
// frontend/src/components/ProtectedRoute.tsx
const ProtectedRoute = ({ children }) => {
  const { user, loading } = useAuth();
  const navigate = useNavigate();
  const location = useLocation();

  useEffect(() => {
    if (!loading && user) {
      // Role-based landing page routing
      if (location.pathname === '/login-success' || location.pathname === '/') {
        const role = getUserRole(user);

        switch(role) {
          case 'admin':
          case 'zookeeper':
            navigate('/dashboard');
            break;
          case 'parent':
          case 'student':
          case 'visitor':
          default:
            navigate('/animals');
            break;
        }
      }
    }
  }, [user, loading, location]);

  return children;
};
```

### Step 4: Update Routes Configuration
```typescript
// frontend/src/App.tsx or routes.tsx
<Routes>
  {/* Public routes */}
  <Route path="/login" element={<Login />} />

  {/* Protected routes with role-based access */}
  <Route element={<ProtectedRoute />}>
    {/* Public animal pages - accessible to all authenticated users */}
    <Route path="/animals" element={<PublicAnimalList />} />
    <Route path="/animals/:id" element={<AnimalDetails />} />
    <Route path="/chat" element={<Chat />} />

    {/* Admin routes - restricted access */}
    <Route path="/dashboard" element={
      <RequireRole roles={['admin', 'zookeeper']}>
        <Dashboard />
      </RequireRole>
    } />
    <Route path="/animals/config" element={
      <RequireRole roles={['admin', 'zookeeper']}>
        <AnimalConfig />
      </RequireRole>
    } />
  </Route>
</Routes>
```

### Step 5: Update Navigation to Include Animal Portal Under Conversations

```typescript
// frontend/src/components/Navigation.tsx
// Update the existing sidebar navigation to add the animal portal

const Navigation = () => {
  const { user } = useAuth();
  const role = getUserRole(user);
  const [conversationsExpanded, setConversationsExpanded] = useState(false);

  // Common menu structure with nested items
  const menuStructure = [
    {
      label: 'Dashboard',
      path: '/dashboard',
      icon: LayoutDashboard,
      roles: ['admin', 'zookeeper']
    },
    {
      label: 'Animal Management',
      icon: Zap,
      roles: ['admin', 'zookeeper'],
      children: [
        { label: 'Chatbot Personalities', path: '/animals/config' },
        { label: 'Animal Details', path: '/animals/details' }
      ]
    },
    {
      label: 'Family Groups',
      path: '/families',
      icon: Users,
      roles: ['admin', 'zookeeper', 'parent']
    },
    {
      label: 'Conversations',
      icon: MessageCircle,
      roles: ['all'], // Available to everyone
      children: [
        {
          label: 'Chat with Animals',
          path: '/animals',
          description: 'Browse and chat with our animal ambassadors'
        },
        {
          label: 'Chat History',
          path: '/conversations/history',
          roles: ['admin', 'zookeeper', 'parent'] // Restricted
        },
        {
          label: 'Active Chats',
          path: '/conversations/active',
          roles: ['admin', 'zookeeper']
        }
      ]
    },
    {
      label: 'Knowledge Base',
      path: '/knowledge',
      icon: BookOpen,
      roles: ['admin', 'zookeeper']
    },
    {
      label: 'User Management',
      path: '/users',
      icon: Users,
      roles: ['admin']
    },
    {
      label: 'Analytics',
      path: '/analytics',
      icon: BarChart,
      roles: ['admin', 'zookeeper']
    },
    {
      label: 'System',
      path: '/system',
      icon: Settings,
      roles: ['admin']
    }
  ];

  // Filter menu items based on role
  const filterMenuByRole = (items) => {
    return items.filter(item => {
      if (item.roles && item.roles[0] !== 'all') {
        if (!item.roles.includes(role)) return false;
      }
      if (item.children) {
        item.children = item.children.filter(child =>
          !child.roles || child.roles.includes(role) || child.roles[0] === 'all'
        );
      }
      return true;
    });
  };

  const visibleMenu = filterMenuByRole(menuStructure);

  return (
    <nav className="sidebar-navigation">
      {visibleMenu.map(item => (
        <div key={item.path || item.label}>
          {item.children ? (
            // Expandable menu item
            <div>
              <button
                onClick={() => {
                  if (item.label === 'Conversations') {
                    setConversationsExpanded(!conversationsExpanded);
                  }
                  // Handle other expandables similarly
                }}
                className="menu-item expandable"
              >
                <item.icon className="w-5 h-5 mr-2" />
                {item.label}
                <ChevronDown className={`w-4 h-4 ml-auto transform ${
                  conversationsExpanded ? 'rotate-180' : ''
                }`} />
              </button>

              {conversationsExpanded && item.label === 'Conversations' && (
                <div className="submenu">
                  {item.children.map(child => (
                    <NavLink
                      key={child.path}
                      to={child.path}
                      className="submenu-item"
                    >
                      {child.label}
                      {child.description && (
                        <span className="text-xs text-gray-500 block">
                          {child.description}
                        </span>
                      )}
                    </NavLink>
                  ))}
                </div>
              )}
            </div>
          ) : (
            // Regular menu item
            <NavLink to={item.path} className="menu-item">
              <item.icon className="w-5 h-5 mr-2" />
              {item.label}
            </NavLink>
          )}
        </div>
      ))}
    </nav>
  );
};
```

### Step 6: Update Existing Sidebar to Add Animal Portal Link

```typescript
// frontend/src/components/Sidebar.tsx (or wherever your sidebar is)
// ADD this to the existing Conversations menu section

// Find the Conversations button in your existing sidebar and update it:
<div>
  <button
    onClick={() => setConversationsExpanded(!conversationsExpanded)}
    className="sidebar-button"
  >
    <MessageCircle className="w-5 h-5" />
    Conversations
    <ChevronDown className={`w-4 h-4 ml-auto ${conversationsExpanded ? 'rotate-180' : ''}`} />
  </button>

  {conversationsExpanded && (
    <div className="pl-8 space-y-1">
      {/* ADD THIS NEW LINK */}
      <button
        onClick={() => navigate('/animals')}
        className="sidebar-submenu-item"
      >
        Chat with Animals
      </button>

      {/* Existing conversation links */}
      {['admin', 'zookeeper'].includes(userRole) && (
        <>
          <button
            onClick={() => navigate('/conversations/history')}
            className="sidebar-submenu-item"
          >
            Chat History
          </button>
          <button
            onClick={() => navigate('/conversations/active')}
            className="sidebar-submenu-item"
          >
            Active Sessions
          </button>
        </>
      )}
    </div>
  )}
</div>
```

## Testing Checklist

### Authentication Flow
- [ ] Visitor login → redirects to `/animals`
- [ ] Student login → redirects to `/animals`
- [ ] Parent login → redirects to `/animals`
- [ ] Zookeeper login → redirects to `/dashboard`
- [ ] Admin login → redirects to `/dashboard`

### Public Animal List
- [ ] Displays only active animals
- [ ] View Details button works
- [ ] Chat button navigates with animalId
- [ ] Responsive on mobile
- [ ] Loading state shows
- [ ] Empty state if no animals

### Navigation
- [ ] Public users see limited menu
- [ ] Admins see full menu
- [ ] Role-appropriate sidebar items
- [ ] Logout works for all roles

### Permissions
- [ ] Public users cannot access `/dashboard`
- [ ] Public users cannot access `/animals/config`
- [ ] Admins can access all routes
- [ ] Proper 403 error pages

## User Journey Flows

### Visitor/Student/Parent Flow
```
Login → Public Animal List
      ↓
Select Animal → View Details OR Start Chat
      ↓
Chat Interface (with animal context)
      ↓
Can return to list or switch animals
```

### Admin/Zookeeper Flow
```
Login → Admin Dashboard
      ↓
Full menu access including:
- Animal Configuration
- User Management
- Analytics
      ↓
Can still access public views for testing
```

## Mobile Considerations
- Touch-friendly button sizes (min 44x44px)
- Responsive grid layout
- Simplified navigation for mobile
- Optimized chat interface for mobile keyboards
- Swipe gestures for animal browsing

## Security Considerations
- Role validation on backend API calls
- JWT token role claims verification
- Prevent URL manipulation to access restricted routes
- Audit log for role-based access attempts
- Session timeout for public kiosks

## Performance Optimizations
- Lazy load animal images
- Paginate animal list for large datasets
- Cache animal data in session storage
- Preload chat interface for faster access
- Implement virtual scrolling for long lists

## Future Enhancements
1. **Favorites System**: Allow users to favorite animals
2. **Recently Chatted**: Show recent conversations
3. **Animal Categories**: Filter by habitat, species, etc.
4. **Search Functionality**: Search animals by name or traits
5. **Multi-language Support**: For international visitors
6. **Accessibility**: Screen reader support, keyboard navigation
7. **Progressive Web App**: Offline capability for basic features

## Success Metrics
- Time to first chat interaction < 3 clicks
- Page load time < 2 seconds
- Mobile responsiveness score > 95%
- User role routing accuracy = 100%
- Zero unauthorized access incidents

## Dependencies
- React Router for navigation
- JWT decode library for role detection
- Tailwind CSS for styling
- Lucide React for icons
- Existing animal API endpoints

## Error Handling
- Graceful fallback if role detection fails
- Clear error messages for access denied
- Retry logic for API failures
- Offline mode detection
- Session expiry handling

## Rollback Plan
If issues arise:
1. Revert routing changes
2. Direct all users to dashboard (current behavior)
3. Maintain audit log of issues
4. Hot-fix role detection logic
5. Gradual rollout by user group