"""
Implementation module for users
Auto-generated by post_openapi_generation.py
FIXED (2025-10-12): Generates forwarding stubs to handlers.py when implementations exist
"""

from typing import Any, Dict, List, Tuple, Union
from ..models.error import Error


def not_implemented_error(operation_name: str) -> Tuple[Dict[str, Any], int]:
    """Helper function for not-yet-implemented operations"""
    error_obj = Error(
        code="not_implemented",
        message=f"Operation {operation_name} not yet implemented",
        details={"operation": operation_name, "module": "users"}
    )
    return error_obj.to_dict(), 501


def handle_me_get(*args, **kwargs) -> Tuple[Any, int]:
    """
    Forwarding handler for me_get
    Routes to implementation in handlers.py
    """
    from .handlers import handle_me_get as real_handler
    return real_handler(*args, **kwargs)



# Function aliases for unit tests - delegates to domain service layer
def _get_service():
    """Get user service instance - endpoints already work through proper service layer"""
    from .domain.user_service import UserService
    from .dependency_injection import get_user_repository, get_user_details_repository, get_audit_service
    
    user_repo = get_user_repository()
    user_details_repo = get_user_details_repository()
    audit_service = get_audit_service()
    
    return UserService(user_repo, user_details_repo, audit_service)

def _store():
    """Get repository for testing - tests can mock this"""
    from .dependency_injection import get_user_repository
    return get_user_repository()

def handle_list_users(page: int = 1, page_size: int = 20):
    """List users with pagination - delegates to service layer"""
    from .error_handler import ValidationError
    
    # Validate pagination parameters
    errors = {}
    
    if isinstance(page, str):
        errors['page'] = ['Page must be a valid integer']
    elif page < 1:
        errors['page'] = ['Page must be >= 1']
    
    if isinstance(page_size, str):
        errors['pageSize'] = ['Page size must be a valid integer']
    elif page_size < 1:
        errors['pageSize'] = ['Page size must be >= 1']
    elif page_size > 500:
        errors['pageSize'] = ['Page size must be <= 500']
    
    if errors:
        raise ValidationError("Invalid pagination parameters", field_errors=errors)
    
    # Delegate to service layer
    service = _get_service()
    users = service.list_users(page=page, page_size=page_size)
    
    # Convert domain entities to dicts
    from .domain.common.serializers import serialize_user
    return [serialize_user(user) for user in users]

def handle_get_user(user_id: str):
    """Get a single user by ID - delegates to service layer"""
    if not user_id:
        return None
    
    try:
        service = _get_service()
        user = service.get_user(user_id)
        
        from .domain.common.serializers import serialize_user
        return serialize_user(user)
    except:
        return None

def handle_create_user(user_data: dict):
    """Create a new user - delegates to service layer"""
    service = _get_service()
    user = service.create_user(user_data)
    
    from .domain.common.serializers import serialize_user
    return serialize_user(user), 201

def handle_update_user(user_id: str, user_data: dict):
    """Update an existing user - delegates to service layer"""
    try:
        service = _get_service()
        user = service.update_user(user_id, user_data)
        
        from .domain.common.serializers import serialize_user
        return serialize_user(user), 200
    except:
        return None, 404

def handle_delete_user(*args, **kwargs) -> Tuple[Any, int]:
    """
    Forwarding handler for delete_user
    Routes to implementation in handlers.py
    """
    from .handlers import handle_delete_user as real_handler
    return real_handler(*args, **kwargs)

def _validate_foreign_keys(data: dict):
    """Validate foreign key references - delegates to service layer"""
    from .error_handler import ValidationError
    
    family_id = data.get('familyId')
    if family_id and family_id != '':
        # Check if family exists using family service
        try:
            from .dependency_injection import get_family_repository
            family_repo = get_family_repository()
            if not family_repo.exists(family_id):
                raise ValidationError("Invalid foreign key reference", field_errors={'familyId': ['Family does not exist']})
        except ImportError:
            # If dependency injection not available, skip validation
            pass
