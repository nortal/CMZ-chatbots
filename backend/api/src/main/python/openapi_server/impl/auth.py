"""
Implementation module for auth
Auto-generated by post_openapi_generation.py
"""

import os
import jwt
import datetime
from typing import Any, Dict, List, Tuple, Union
from ..models.error import Error


# Mock users for testing
MOCK_USERS = {
    'test@cmz.org': {'password': 'testpass123', 'role': 'user', 'userId': 'test_user'},
    'admin@cmz.org': {'password': 'admin123', 'role': 'admin', 'userId': 'admin_user'},
    'parent1@test.cmz.org': {'password': 'testpass123', 'role': 'parent', 'userId': 'parent1'},
    'student1@test.cmz.org': {'password': 'testpass123', 'role': 'student', 'userId': 'student1'},
    'student2@test.cmz.org': {'password': 'testpass123', 'role': 'student', 'userId': 'student2'},
    'user_parent_001@cmz.org': {'password': 'testpass123', 'role': 'parent', 'userId': 'user_parent_001'},
}


def generate_jwt(user_data: Dict[str, str]) -> str:
    """Generate JWT token for user"""
    secret = os.environ.get('JWT_SECRET', 'dev-secret-key')
    payload = {
        'email': user_data.get('email'),
        'userId': user_data.get('userId'),
        'user_id': user_data.get('userId'),  # Include both formats for compatibility
        'role': user_data.get('role'),
        'iat': datetime.datetime.utcnow(),
        'exp': datetime.datetime.utcnow() + datetime.timedelta(hours=24)
    }
    return jwt.encode(payload, secret, algorithm='HS256')


def authenticate_user(email: str, password: str) -> Dict[str, Any]:
    """Authenticate user with mock data"""
    # Check if user exists in mock data
    user_info = MOCK_USERS.get(email)
    if not user_info or user_info['password'] != password:
        raise ValueError("Invalid email or password")

    # Generate token
    user_data = {
        'email': email,
        'userId': user_info['userId'],
        'role': user_info['role']
    }
    token = generate_jwt(user_data)

    # Return auth response
    return {
        'token': token,
        'user': user_data,
        'expiresIn': 86400  # 24 hours in seconds
    }


def not_implemented_error(operation_name: str) -> Tuple[Dict[str, Any], int]:
    """Helper function for not-yet-implemented operations"""
    error_obj = Error(
        code="not_implemented",
        message=f"Operation {operation_name} not yet implemented",
        details={"operation": operation_name, "module": "auth"}
    )
    return error_obj.to_dict(), 501


def handle_auth_logout_post(*args, **kwargs) -> Tuple[Any, int]:
    """
    Implementation handler for auth_logout_post

    TODO: Implement business logic for this operation
    """
    return {}, 204  # Return empty with 204 No Content for logout


def handle_auth_post(*args, **kwargs) -> Tuple[Any, int]:
    """
    Implementation handler for auth_post - delegates to authenticate_user
    """
    # Extract body from args/kwargs
    body = None
    if args:
        body = args[0]
    elif 'body' in kwargs:
        body = kwargs['body']

    if not body:
        error = Error(
            code="missing_body",
            message="Request body is required",
            details={}
        )
        return error.to_dict(), 400

    # Handle both dict and model object
    if hasattr(body, 'to_dict'):
        body = body.to_dict()

    # Extract email/username and password
    email = body.get('email', body.get('username', ''))
    password = body.get('password', '')

    if not email or not password:
        error = Error(
            code="invalid_request",
            message="Email/username and password are required",
            details={}
        )
        return error.to_dict(), 400

    try:
        result = authenticate_user(email, password)
        return result, 200
    except ValueError as e:
        error = Error(
            code="authentication_failed",
            message=str(e),
            details={}
        )
        return error.to_dict(), 401


def handle_auth_refresh_post(*args, **kwargs) -> Tuple[Any, int]:
    """
    Implementation handler for auth_refresh_post

    TODO: Implement business logic for this operation
    """
    return not_implemented_error("auth_refresh_post")


def handle_auth_reset_password_post(*args, **kwargs) -> Tuple[Any, int]:
    """
    Implementation handler for auth_reset_password_post

    TODO: Implement business logic for this operation
    """
    return not_implemented_error("auth_reset_password_post")

