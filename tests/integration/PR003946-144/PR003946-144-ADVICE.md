# PR003946-144: PUT /animal/{id} Implementation Advice

## Ticket Summary
Implement PUT /animal/{id} endpoint for full animal updates with comprehensive validation and audit trail.

## Acceptance Criteria
1. **Endpoint Implementation**: PUT /animal/{id} endpoint responds with 200 on success
2. **Field Validation**: All required fields must be present (name, species, status)
3. **ID Consistency**: Animal ID in URL must match ID in request body
4. **Partial Updates**: Support partial field updates (only changed fields)
5. **Audit Trail**: Track all modifications with timestamps and user info
6. **Optimistic Locking**: Implement version checking to prevent conflicts
7. **Not Found Handling**: Return 404 for non-existent animal IDs
8. **Validation Errors**: Return 400 with detailed error messages
9. **Authorization**: Only authorized users can update animals
10. **Response Format**: Return updated animal object with all fields

## Technical Implementation Notes

### Handler Implementation
- Add `handle_animal_id_put` to handlers.py
- Map to `animal_id_put` in handler_map
- Handle both `id_` and `id` parameter names (Connexion quirk)

### Validation Rules
- Required fields: name, species, status
- Status enum: active, inactive, archived
- Species validation: must be from approved list
- Name: 2-100 characters, alphanumeric + spaces

### Audit Trail Structure
```python
{
    "modified": {
        "at": "2025-01-15T10:30:00Z",
        "by": "user123"
    },
    "version": 2,
    "changes": {
        "name": {"old": "Leo", "new": "Leo the Lion"},
        "status": {"old": "active", "new": "inactive"}
    }
}
```

### Error Response Format
```json
{
    "code": "validation_error",
    "message": "Validation failed",
    "details": {
        "species": "Invalid species: must be one of [Lion, Tiger, Bear, ...]",
        "name": "Name too short: minimum 2 characters"
    }
}
```

## Common Issues & Solutions

### Issue 1: Parameter Name Mismatch
**Problem**: Connexion passes `id_` but handler expects `id`
**Solution**: Accept both parameter names in handler signature

### Issue 2: Body Parameter Missing
**Problem**: Generated controller doesn't pass body to handler
**Solution**: Fix controller template or manually patch after generation

### Issue 3: Version Conflict
**Problem**: Concurrent updates cause data loss
**Solution**: Check version field before update, return 409 on conflict

## Testing Strategy

### Unit Tests
- Test field validation logic
- Test audit trail generation
- Test version checking

### Integration Tests
- Test full update flow
- Test partial update flow
- Test error scenarios (404, 400, 409)
- Test authorization checks

### E2E Tests
- Test via Playwright with actual UI
- Verify data persistence to DynamoDB
- Confirm audit trail in database

## Dependencies
- OpenAPI spec must define PUT /animal/{id}
- DynamoDB table must have version field
- Auth middleware must be configured
- Animal model must support all fields