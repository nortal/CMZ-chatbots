AWSTemplateFormatVersion: '2010-09-09'
Description: CMZ Chatbots - Core AWS Serverless Architecture

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Project Settings"
        Parameters:
          - ProjectName
          - StageName
      - Label:
          default: "API Gateway"
        Parameters:
          - ApiGatewayStageName
          - ApiGatewayCustomDomainName
          - ApiGatewayHostedZoneId
          - EnableApiWaf
      - Label:
          default: "Cognito Authentication"
        Parameters:
          - CognitoDomainPrefix
          - CallbackURLs
      - Label:
          default: "Lambda Function"
        Parameters:
          - LambdaS3Bucket
          - LambdaS3Key
          - LambdaTimeout
          - LambdaMemorySize
      - Label:
          default: "DynamoDB"
        Parameters:
          - DynamoBillingMode
          - DynamoReadCapacity
          - DynamoWriteCapacity
      - Label:
          default: "OpenAPI Specification"
        Parameters:
          - OpenApiS3Bucket
          - OpenApiS3Key
      - Label:
          default: "CloudWatch"
        Parameters:
          - CloudwatchRetentionInDays
      - Label:
          default: "Frontend Hosting"
        Parameters:
          - FrontendDomainName
          - FrontendHostedZoneId
          - EnableFrontendHttps

    ParameterLabels:
      ProjectName:
        default: "Project Name Prefix"
      StageName:
        default: "Environment/Stage Name"
      ApiGatewayStageName:
        default: "API Gateway Stage Name"
      CognitoDomainPrefix:
        default: "Cognito Domain Prefix"
      LambdaS3Bucket:
        default: "Lambda S3 Bucket"
      LambdaS3Key:
        default: "Lambda S3 Key"
      LambdaTimeout:
        default: "Lambda Timeout (seconds)"
      LambdaMemorySize:
        default: "Lambda Memory Size (MB)"
      OpenApiS3Bucket:
        default: "OpenAPI S3 Bucket"
      OpenApiS3Key:
        default: "OpenAPI S3 Key"
      DynamoBillingMode:
        default: "DynamoDB Billing Mode"
      DynamoReadCapacity:
        default: "DynamoDB Read Capacity Units"
      DynamoWriteCapacity:
        default: "DynamoDB Write Capacity Units"
      CallbackURLs:
        default: "Cognito Callback URLs"
      CloudwatchRetentionInDays:
        default: "CloudWatch Log Retention (days)"
      ApiGatewayCustomDomainName:
        default: "API Gateway Custom Domain Name"
      ApiGatewayHostedZoneId:
        default: "API Gateway Hosted Zone ID"
      EnableApiWaf:
        default: "Enable API Gateway WAF"
      FrontendDomainName:
        default: "Frontend Domain Name"
      FrontendHostedZoneId:
        default: "Frontend Hosted Zone ID"
      EnableFrontendHttps:
        default: "Enable Frontend HTTPS"

Parameters:
  ProjectName:
    Type: String
    Description: Project name prefix for all resources (e.g., cmz)
  StageName:
    Type: String
    Description: Environment/stage name (e.g., dev, prod)

  ApiGatewayStageName:
    Type: String
    Default: prod
    Description: API Gateway stage name
  ApiGatewayCustomDomainName:
    Type: String
    Default: ""
    Description: (Optional) Custom domain name for API Gateway (leave blank for none)
  ApiGatewayHostedZoneId:
    Type: String
    Default: ""
    Description: (Optional) Route53 Hosted Zone ID for the API custom domain
  EnableApiWaf:
    Type: String
    AllowedValues: [true, false]
    Default: false
    Description: Attach a WAF WebACL to API Gateway if true

  CognitoDomainPrefix:
    Type: String
    Description: Prefix for Cognito Hosted UI domain (must be globally unique)
  CallbackURLs:
    Type: CommaDelimitedList
    Description: Allowed Cognito OAuth callback URLs (comma-separated)

  LambdaS3Bucket:
    Type: String
    Default: ""
    Description: S3 bucket for Lambda deployment package (leave blank to use default inline code)
  LambdaS3Key:
    Type: String
    Default: ""
    Description: S3 key for Lambda deployment package (leave blank to use default inline code)
  LambdaTimeout:
    Type: Number
    Default: 30
    Description: Lambda function timeout in seconds
  LambdaMemorySize:
    Type: Number
    MinValue: 128
    MaxValue: 1024
    Default: 128
    Description: Lambda function memory size in MB

  DynamoBillingMode:
    Type: String
    AllowedValues:
      - PAY_PER_REQUEST
      - PROVISIONED
    Default: PAY_PER_REQUEST
    Description: DynamoDB Billing Mode (PAY_PER_REQUEST or PROVISIONED)
  DynamoReadCapacity:
    Type: Number
    Default: 5
    Description: DynamoDB Read Capacity Units (only used if PROVISIONED)
  DynamoWriteCapacity:
    Type: Number
    Default: 5
    Description: DynamoDB Write Capacity Units (only used if PROVISIONED)

  OpenApiS3Bucket:
    Type: String
    Default: ""
    Description: S3 bucket where openapi_spec.yaml is stored
  OpenApiS3Key:
    Type: String
    Default: ""
    Description: S3 key for openapi_spec.yaml

  CloudwatchRetentionInDays:
    Type: Number
    Default: 14
    Description: CloudWatch log group retention in days

  FrontendDomainName:
    Type: String
    Default: ""
    Description: (Optional) Custom domain name for the app frontend (e.g., app.cmz.example.com)
  FrontendHostedZoneId:
    Type: String
    Default: ""
    Description: (Optional) Route53 Hosted Zone ID for the frontend domain
  EnableFrontendHttps:
    Type: String
    AllowedValues: [true, false]
    Default: false
    Description: Enable CloudFront and HTTPS for the frontend

Conditions:
  IsProvisioned: !Equals [!Ref DynamoBillingMode, PROVISIONED]
  HasCustomDomain: !Not [!Equals [!Ref ApiGatewayCustomDomainName, ""]]
  HasFrontendDomain: !Not [!Equals [!Ref FrontendDomainName, ""]]
  HasFrontendHostedZone: !Not [!Equals [!Ref FrontendHostedZoneId, ""]]
  EnableFrontendCloudFront: !Equals [!Ref EnableFrontendHttps, true]
  EnableApiGatewayWaf: !Equals [!Ref EnableApiWaf, true]
  HasLambdaS3Bucket: !And
      - !Not [!Equals [!Ref LambdaS3Bucket, ""]]
      - !Not [!Equals [!Ref LambdaS3Key, ""]]
  HasApiGateway: !And
    - !Not [!Equals [!Ref OpenApiS3Bucket, ""]]
    - !Not [!Equals [!Ref OpenApiS3Key, ""]]
  CreateApiGatewayWithDomain: !And
    - !Condition HasApiGateway
    - !Condition HasCustomDomain
  CreateApiGatewayWithWaf: !And
    - !Condition HasApiGateway
    - !Condition EnableApiGatewayWaf
  HasCognito: !Not [!Equals [!Join ["", !Ref CallbackURLs], ""]]
  HasCognitoDomain: !Not [!Equals [!Ref CognitoDomainPrefix, ""]]
  CreateCognitoWithDomain: !And
    - !Condition HasCognito
    - !Condition HasCognitoDomain
  ## Uncomment if authorizer will not be defined in OpenAPI spec
  # CreateApiGatewayWithCognito: !And
  #   - !Condition HasApiGateway
  #   - !Condition HasCognito
  CreateFrontendS3: !And
    - !Condition HasFrontendDomain
    - !Condition HasFrontendHostedZone
  CreateFrontendS3WithoutCloudFront: !And
    - !Condition CreateFrontendS3
    - !Not [!Condition EnableFrontendCloudFront]
  CreateFrontendCloudFront: !And
    - !Condition EnableFrontendCloudFront
    - !Condition CreateFrontendS3


Resources:

  # DynamoDB Tables
  SessionTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-${StageName}-session'
      BillingMode: !Ref DynamoBillingMode
      AttributeDefinitions:
        - AttributeName: sessionId
          AttributeType: S
      KeySchema:
        - AttributeName: sessionId
          KeyType: HASH
      ProvisionedThroughput:
        Fn::If:
          - IsProvisioned
          - ReadCapacityUnits: !Ref DynamoReadCapacity
            WriteCapacityUnits: !Ref DynamoWriteCapacity
          - !Ref "AWS::NoValue"

  ConversationTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-${StageName}-conversation'
      BillingMode: !Ref DynamoBillingMode
      AttributeDefinitions:
        - AttributeName: conversationId
          AttributeType: S
      KeySchema:
        - AttributeName: conversationId
          KeyType: HASH
      ProvisionedThroughput:
        Fn::If:
          - IsProvisioned
          - ReadCapacityUnits: !Ref DynamoReadCapacity
            WriteCapacityUnits: !Ref DynamoWriteCapacity
          - !Ref "AWS::NoValue"

  AnimalTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-${StageName}-animal'
      BillingMode: !Ref DynamoBillingMode
      AttributeDefinitions:
        - AttributeName: animalId
          AttributeType: S
      KeySchema:
        - AttributeName: animalId
          KeyType: HASH
      ProvisionedThroughput:
        Fn::If:
          - IsProvisioned
          - ReadCapacityUnits: !Ref DynamoReadCapacity
            WriteCapacityUnits: !Ref DynamoWriteCapacity
          - !Ref "AWS::NoValue"

  KnowledgeTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-${StageName}-knowledge'
      BillingMode: !Ref DynamoBillingMode
      AttributeDefinitions:
        - AttributeName: knowledgeId
          AttributeType: S
      KeySchema:
        - AttributeName: knowledgeId
          KeyType: HASH
      ProvisionedThroughput:
        Fn::If:
          - IsProvisioned
          - ReadCapacityUnits: !Ref DynamoReadCapacity
            WriteCapacityUnits: !Ref DynamoWriteCapacity
          - !Ref "AWS::NoValue"

  UserTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-${StageName}-user'
      BillingMode: !Ref DynamoBillingMode
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
      ProvisionedThroughput:
        Fn::If:
          - IsProvisioned
          - ReadCapacityUnits: !Ref DynamoReadCapacity
            WriteCapacityUnits: !Ref DynamoWriteCapacity
          - !Ref "AWS::NoValue"

  UserDetailsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-${StageName}-user-details'
      BillingMode: !Ref DynamoBillingMode
      AttributeDefinitions:
        - AttributeName: userDetailsId
          AttributeType: S
      KeySchema:
        - AttributeName: userDetailsId
          KeyType: HASH
      ProvisionedThroughput:
        Fn::If:
          - IsProvisioned
          - ReadCapacityUnits: !Ref DynamoReadCapacity
            WriteCapacityUnits: !Ref DynamoWriteCapacity
          - !Ref "AWS::NoValue"

  FamilyTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-${StageName}-family'
      BillingMode: !Ref DynamoBillingMode
      AttributeDefinitions:
        - AttributeName: familyId
          AttributeType: S
      KeySchema:
        - AttributeName: familyId
          KeyType: HASH
      ProvisionedThroughput:
        Fn::If:
          - IsProvisioned
          - ReadCapacityUnits: !Ref DynamoReadCapacity
            WriteCapacityUnits: !Ref DynamoWriteCapacity
          - !Ref "AWS::NoValue"

  AnimalConfigTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-${StageName}-animal-config'
      BillingMode: !Ref DynamoBillingMode
      AttributeDefinitions:
        - AttributeName: animalConfigId
          AttributeType: S
      KeySchema:
        - AttributeName: animalConfigId
          KeyType: HASH
      ProvisionedThroughput:
        Fn::If:
          - IsProvisioned
          - ReadCapacityUnits: !Ref DynamoReadCapacity
            WriteCapacityUnits: !Ref DynamoWriteCapacity
          - !Ref "AWS::NoValue"

  AnimalDetailsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-${StageName}-animal-details'
      BillingMode: !Ref DynamoBillingMode
      AttributeDefinitions:
        - AttributeName: animalDetailsId
          AttributeType: S
      KeySchema:
        - AttributeName: animalDetailsId
          KeyType: HASH
      ProvisionedThroughput:
        Fn::If:
          - IsProvisioned
          - ReadCapacityUnits: !Ref DynamoReadCapacity
            WriteCapacityUnits: !Ref DynamoWriteCapacity
          - !Ref "AWS::NoValue"

  # Lambda Execution Role
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-${StageName}-lambda-execution-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub '${ProjectName}-${StageName}-lambda-policy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:Query
                  - dynamodb:Scan
                  - dynamodb:DeleteItem
                Resource:
                  - !GetAtt SessionTable.Arn
                  - !GetAtt ConversationTable.Arn
                  - !GetAtt AnimalTable.Arn
                  - !GetAtt KnowledgeTable.Arn
                  - !GetAtt UserTable.Arn
                  - !GetAtt FamilyTable.Arn
                  - !GetAtt AnimalConfigTable.Arn
                  - !GetAtt AnimalDetailTable.Arn
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${ProjectName}-${StageName}-chatbot-backend:*'
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource: !Sub arn:aws:s3:::${OpenApiS3Bucket}/${OpenApiS3Key}
              # Conditionally include Cognito permissions
              - Fn::If:
                  - HasCognito
                  - Effect: Allow
                    Action:
                      - cognito-idp:AdminGetUser
                    Resource: !GetAtt UserPool.Arn
                  - !Ref "AWS::NoValue"

  # Lambda Function
  ChatbotLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${StageName}-chatbot-backend'
      Handler: main.lambda_handler
      Runtime: python3.11
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: !Ref LambdaTimeout
      MemorySize: !Ref LambdaMemorySize
      Environment:
        Variables:
          SESSION_TABLE: !Ref SessionTable
          CONVERSATION_TABLE: !Ref ConversationTable
          ANIMAL_TABLE: !Ref AnimalTable
          KNOWLEDGE_TABLE: !Ref KnowledgeTable
          USER_TABLE: !Ref UserTable
          FAMILY_TABLE: !Ref FamilyTable
          ANIMAL_CONFIG_TABLE: !Ref AnimalConfigTable
          ANIMAL_DETAIL_TABLE: !Ref AnimalDetailTable
          USER_POOL_ID: !If [HasCognito, !Ref UserPool, ""]
      Code:
        Fn::If:
          - HasLambdaS3Bucket
          - S3Bucket: !Ref LambdaS3Bucket
            S3Key: !Ref LambdaS3Key
          - ZipFile: |
              def lambda_handler(event, context):
                  return {
                      "statusCode": 200,
                      "body": "Hello from the default Lambda!"
                  }

  # Cognito User Pool
  UserPool:
    Condition: HasCognito
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub '${ProjectName}-${StageName}-user-pool'
      AutoVerifiedAttributes: [email]
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: false
      UserPoolAddOns:
        AdvancedSecurityMode: ENFORCED
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Name: verified_email
            Priority: 1

  UserPoolClient:
    Condition: HasCognito
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub '${ProjectName}-${StageName}-user-pool-client'
      UserPoolId: !Ref UserPool
      GenerateSecret: false
      AllowedOAuthFlowsUserPoolClient: true
      AllowedOAuthFlows:
        - code
      AllowedOAuthScopes:
        - email
        - openid
        - profile
      CallbackURLs: !Ref CallbackURLs
      SupportedIdentityProviders:
        - COGNITO

  UserPoolDomain:
    Condition: CreateCognitoWithDomain
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      Domain: !Ref CognitoDomainPrefix
      UserPoolId: !Ref UserPool

  # API Gateway (REST API with OpenAPI integration)
  ApiGateway:
    Condition: HasApiGateway
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub '${ProjectName}-${StageName}-api'
      BodyS3Location:
        Bucket: !Ref OpenApiS3Bucket
        Key: !Ref OpenApiS3Key
      EndpointConfiguration:
        Types:
          - REGIONAL

  ApiGatewayDeployment:
    Condition: HasApiGateway
    Type: AWS::ApiGateway::Deployment
    Properties:
      RestApiId: !Ref ApiGateway
      StageName: !Ref ApiGatewayStageName

  ApiGatewayStage:
    Condition: HasApiGateway
    Type: AWS::ApiGateway::Stage
    Properties:
      StageName: !Ref ApiGatewayStageName
      RestApiId: !Ref ApiGateway
      DeploymentId: !Ref ApiGatewayDeployment
      MethodSettings:
        - ResourcePath: "/*"
          HttpMethod: "*"
          LoggingLevel: INFO
          DataTraceEnabled: true
      AccessLogSetting:
        DestinationArn: !GetAtt ApiGatewayAccessLogs.Arn
        Format: |
          {
            "requestId":"$context.requestId",
            "ip":"$context.identity.sourceIp",
            "user":"$context.identity.user",
            "requestTime":"$context.requestTime",
            "httpMethod":"$context.httpMethod",
            "resourcePath":"$context.resourcePath",
            "status":"$context.status",
            "responseLength":"$context.responseLength"
          }

  ApiGatewayAccessLogs:
    Condition: HasApiGateway
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/cmz/${ProjectName}-${StageName}/apigw'
      RetentionInDays: !Ref CloudwatchRetentionInDays

  ApiGatewayLambdaPermission:
    Condition: HasApiGateway
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ChatbotLambda
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGateway}/*/*

  ## May drift if also defined in the OpenAPI spec
  # ApiGatewayCognitoAuthorizer:
  #   Condition: CreateApiGatewayWithCognito
  #   Type: AWS::ApiGateway::Authorizer
  #   Properties:
  #     Name: !Sub '${ProjectName}-${StageName}-cognito-authorizer'
  #     Type: COGNITO_USER_POOLS
  #     IdentitySource: method.request.header.Authorization
  #     RestApiId: !Ref ApiGateway
  #     ProviderARNs:
  #       - !GetAtt UserPool.Arn

  ApiGatewayCertificate:
    Condition: CreateApiGatewayWithDomain
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: !Ref ApiGatewayCustomDomainName
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName: !Ref ApiGatewayCustomDomainName
          HostedZoneId: !Ref ApiGatewayHostedZoneId

  ApiGatewayCustomDomain:
    Condition: CreateApiGatewayWithDomain
    Type: AWS::ApiGateway::DomainName
    Properties:
      DomainName: !Ref ApiGatewayCustomDomainName
      EndpointConfiguration:
        Types:
          - REGIONAL
      RegionalCertificateArn: !Ref ApiGatewayCertificate

  ApiGatewayBasePathMapping:
    Condition: CreateApiGatewayWithDomain
    Type: AWS::ApiGateway::BasePathMapping
    Properties:
      DomainName: !Ref ApiGatewayCustomDomainName
      RestApiId: !Ref ApiGateway
      Stage: !Ref ApiGatewayStageName

  ApiGatewayCustomDomainRecord:
    Condition: CreateApiGatewayWithDomain
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref ApiGatewayHostedZoneId
      Name: !Ref ApiGatewayCustomDomainName
      Type: A
      AliasTarget:
        DNSName: !GetAtt ApiGatewayCustomDomain.DistributionDomainName
        HostedZoneId: !GetAtt ApiGatewayCustomDomain.DistributionHostedZoneId

  ApiWafWebAcl:
    Condition: CreateApiGatewayWithWaf
    Type: AWS::WAFv2::WebACL
    Properties:
      Name: !Sub '${ProjectName}-${StageName}-api-waf'
      Scope: REGIONAL
      DefaultAction:
        Allow: {}
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName: !Sub '${ProjectName}-${StageName}-api-waf'
      Rules:
        - Name: AWS-AWSManagedRulesCommonRuleSet
          Priority: 1
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesCommonRuleSet
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: !Sub '${ProjectName}-${StageName}-api-waf-common'

  ApiGatewayWebAclAssociation:
    Condition: CreateApiGatewayWithWaf
    Type: AWS::WAFv2::WebACLAssociation
    Properties:
      ResourceArn: !Sub 'arn:aws:apigateway:${AWS::Region}::/restapis/${ApiGateway}/stages/${ApiGatewayStageName}'
      WebACLArn: !Ref ApiWafWebAcl

  # S3 bucket for static frontend hosting (HTTP only)
  FrontendS3Bucket:
    Condition: CreateFrontendS3
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref FrontendDomainName
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: error.html

  # S3 bucket policy to allow public read (for static website hosting)
  FrontendS3BucketPolicy:
    Condition: CreateFrontendS3
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref FrontendS3Bucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: PublicReadGetObject
            Effect: Allow
            Principal: "*"
            Action:
              - s3:GetObject
            Resource: !Sub "${FrontendS3Bucket}/*"

  # CloudFront distribution for S3 static site (HTTPS)
  FrontendCertificate:
    Condition: CreateFrontendCloudFront
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: !Ref FrontendDomainName
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName: !Ref FrontendDomainName
          HostedZoneId: !Ref FrontendHostedZoneId

  FrontendCloudFrontDistribution:
    Condition: CreateFrontendCloudFront
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Aliases:
          - !Ref FrontendDomainName
        Origins:
          - Id: S3Origin
            DomainName: !GetAtt FrontendS3Bucket.RegionalDomainName
            S3OriginConfig: {}
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods: [GET, HEAD]
          CachedMethods: [GET, HEAD]
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none
        ViewerCertificate:
          AcmCertificateArn: !Ref FrontendCertificate
          SslSupportMethod: sni-only
        DefaultRootObject: index.html
        HttpVersion: http2
        PriceClass: PriceClass_100

  # Route53 record for frontend CloudFront distribution (HTTPS)
  FrontendCloudFrontDomainRecord:
    Condition: CreateFrontendCloudFront
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref FrontendHostedZoneId
      Name: !Ref FrontendDomainName
      Type: A
      AliasTarget:
        DNSName: !GetAtt FrontendCloudFrontDistribution.DomainName
        HostedZoneId: Z2FDTNDATAQYW2 # CloudFront global hosted zone ID

  # Route53 record for S3 static website (HTTP only, if HTTPS/CloudFront not enabled)
  FrontendS3DomainRecord:
    Condition: CreateFrontendS3WithoutCloudFront
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref FrontendHostedZoneId
      Name: !Ref FrontendDomainName
      Type: A
      AliasTarget:
        DNSName: !GetAtt FrontendS3Bucket.WebsiteURL
        HostedZoneId: !FindInMap [S3WebsiteHostedZoneIdMap, !Ref "AWS::Region", HostedZoneId]

Mappings:
  S3WebsiteHostedZoneIdMap:
    us-east-1:      { HostedZoneId: Z3AQBSTGFYJSTF }
    us-west-1:      { HostedZoneId: Z2F56UZL2M1ACD }
    us-west-2:      { HostedZoneId: Z3BJ6K6RIION7M }
    eu-west-1:      { HostedZoneId: Z1BKCTXD74EZPE }
    ap-southeast-1: { HostedZoneId: Z3O0J2DXBE1FTB }
    ap-southeast-2: { HostedZoneId: Z1WCIGYICN2BYD }
    ap-northeast-1: { HostedZoneId: Z2M4EHUR26P7ZW }
    sa-east-1:      { HostedZoneId: Z31GFT0UA1I2HV }
    eu-central-1:   { HostedZoneId: Z21DNDUVLTQW6Q }
    # ...add other regions as needed...

Outputs:
  ApiUrl:
    Condition: HasApiGateway
    Description: API Gateway Invoke URL
    Value: !Sub https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/${ApiGatewayStageName}/
  ApiGatewayCustomDomainName:
    Condition: CreateApiGatewayWithDomain
    Description: Custom domain name for API Gateway
    Value: !Ref ApiGatewayCustomDomainName
  ApiGatewayCustomDomainUrl:
    Condition: CreateApiGatewayWithDomain
    Description: Custom domain invoke URL
    Value: !Sub https://${ApiGatewayCustomDomainName}/${ApiGatewayStageName}/
  CognitoUserPoolId:
    Condition: HasCognito
    Description: Cognito User Pool ID
    Value: !Ref UserPool
  LambdaFunctionName:
    Description: Lambda Function Name
    Value: !Ref ChatbotLambda
  SessionTableName:
    Description: DynamoDB Session Table Name
    Value: !Ref SessionTable
  ConversationTableName:
    Description: DynamoDB Conversation Table Name
    Value: !Ref ConversationTable
  AnimalTableName:
    Description: DynamoDB Animal Table Name
    Value: !Ref AnimalTable
  KnowledgeTableName:
    Description: DynamoDB Knowledge Table Name
    Value: !Ref KnowledgeTable
  UserTableName:
    Description: DynamoDB User Table Name
    Value: !Ref UserTable
  FamilyTableName:
    Description: DynamoDB Family Table Name
    Value: !Ref FamilyTable
  AnimalConfigTableName:
    Description: DynamoDB AnimalConfig Table Name
    Value: !Ref AnimalConfigTable
  AnimalDetailTableName:
    Description: DynamoDB AnimalDetail Table Name
    Value: !Ref AnimalDetailTable
  FrontendS3BucketName:
    Condition: CreateFrontendS3
    Description: S3 bucket name for static frontend hosting
    Value: !Ref FrontendS3Bucket
  FrontendDomainName:
    Condition: HasFrontendDomain
    Description: Custom domain name for the app frontend
    Value: !Sub 'https://${FrontendDomainName}'
