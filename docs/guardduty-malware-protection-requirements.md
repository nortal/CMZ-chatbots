# AWS GuardDuty Malware Protection Requirements

## Overview

This document outlines the AWS GuardDuty malware protection requirements for the CMZ Animal Assistant Management System knowledge base document processing pipeline.

## Security Requirements

The research.md specifies:
- **5-layer security defense** including malware scanning
- **Document processing pipeline**: Upload → Validate → Extract → Embed → Index
- **Two-bucket S3 architecture**: quarantine → malware scan → production

## GuardDuty Configuration Needed

### 1. GuardDuty Detector Setup

```bash
# Enable GuardDuty with malware protection
aws guardduty create-detector \
  --enable \
  --finding-publishing-frequency FIFTEEN_MINUTES \
  --features Name=MALWARE_PROTECTION,Status=ENABLED \
            Name=S3_DATA_EVENTS,Status=ENABLED
```

### 2. S3 Bucket Protection

**Buckets to protect:**
- `cmz-knowledge-base-production`
- `cmz-knowledge-base-quarantine`

**Required tags:**
```json
{
  "CMZ-SecurityMonitoring": "enabled",
  "CMZ-MalwareScanning": "guardduty",
  "CMZ-Purpose": "knowledge-base"
}
```

### 3. Malware Detection Workflow

```
File Upload → S3 Bucket → GuardDuty Scan → {
  ✅ Clean: Process normally
  ❌ Infected: Move to quarantine, block processing
}
```

### 4. Event Integration

**EventBridge Rule Pattern:**
```json
{
  "source": ["aws.guardduty"],
  "detail-type": ["GuardDuty Finding"],
  "detail": {
    "service": {"serviceName": ["S3"]},
    "type": ["Discovery:S3-MaliciousObject"]
  }
}
```

**Required Actions:**
- Block processing of infected files
- Update DynamoDB file status to `FAILED`
- Send administrator notifications
- Move file to quarantine bucket

### 5. Cost Optimization

**Estimated Costs:**
- GuardDuty: $0.50/GB for malware scanning
- Expected usage: ~50 files/month × 10MB avg = 500MB = $0.25/month
- EventBridge: $1.00/million events (negligible)
- Total: ~$1-2/month for malware protection

**Optimization strategies:**
- Scan only new uploads (not existing files)
- Archive low-severity findings
- Use S3 lifecycle policies for quarantine cleanup

### 6. Integration Points

**DynamoDB Integration:**
```python
# Update file processing status
await knowledge_file_table.update_item(
    Key={'fileId': file_id},
    UpdateExpression='SET processingStatus = :status, processingError = :error',
    ExpressionAttributeValues={
        ':status': 'FAILED',
        ':error': 'Malware detected by GuardDuty'
    }
)
```

**Lambda Handler Example:**
```python
def handle_malware_finding(event, context):
    """Handle GuardDuty malware findings."""

    # Extract S3 object details
    s3_details = event['detail']['service']['s3BucketDetails'][0]
    bucket_name = s3_details['name']

    # Move to quarantine
    quarantine_key = f"infected/{timestamp}/{original_key}"
    s3.copy_object(...)
    s3.delete_object(...)

    # Update processing status
    dynamodb.update_item(...)

    # Send notifications
    sns.publish(...)
```

## Required Permissions

**IAM Permissions needed:**
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "guardduty:CreateDetector",
        "guardduty:UpdateDetector",
        "guardduty:GetDetector",
        "guardduty:ListDetectors",
        "guardduty:CreateFilter",
        "s3:PutBucketTagging",
        "events:PutRule",
        "lambda:CreateFunction",
        "iam:CreateRole",
        "iam:AttachRolePolicy"
      ],
      "Resource": "*"
    }
  ]
}
```

## Verification Steps

1. **Test EICAR file upload:**
   ```bash
   # Create EICAR test virus file
   echo 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' > eicar.txt

   # Upload to test bucket
   aws s3 cp eicar.txt s3://cmz-knowledge-base-quarantine/test/

   # Verify GuardDuty detection (within 15 minutes)
   aws guardduty get-findings --detector-id $DETECTOR_ID
   ```

2. **Monitor GuardDuty Console:**
   - Check for `Discovery:S3-MaliciousObject` findings
   - Verify findings include CMZ bucket names
   - Confirm severity scoring works correctly

3. **Test Event Integration:**
   - Upload test malware file
   - Verify EventBridge rule triggers
   - Check Lambda function execution logs
   - Confirm DynamoDB status updates

## Current Status

- **Script Created**: `scripts/configure_guardduty_protection.py`
- **Documentation**: Complete implementation guide
- **Permissions**: Require AWS administrator to enable GuardDuty
- **Next Steps**: Execute script once permissions granted

## Production Deployment

**Prerequisites:**
1. AWS administrator enables GuardDuty in CMZ account
2. Grant necessary IAM permissions to deployment user
3. Execute configuration script
4. Test with EICAR file
5. Integrate with document processing pipeline

**Timeline:**
- Configuration: 30 minutes
- Testing: 1 hour
- Integration: 2 hours
- **Total**: Half-day implementation

This malware protection layer is **critical** for the 5-layer security defense specified in the research requirements and ensures the knowledge base upload pipeline is secure against malicious documents.