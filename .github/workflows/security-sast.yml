# Static Application Security Testing (SAST) with Semgrep
# Scans source code for security vulnerabilities during CI/CD

name: SAST Security Scan
on:
  push:
    branches: [ main, dev, 'kcs/*' ]
  pull_request:
    branches: [ main, dev ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  semgrep:
    name: Semgrep SAST Scan
    runs-on: ubuntu-latest
    
    # Skip duplicate runs on push and pull request events
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name != github.repository
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Fetch full git history for better analysis
          fetch-depth: 0

      - name: Run Semgrep security scan
        uses: semgrep/semgrep-action@v1
        with:
          # Use comprehensive rule sets for Python Flask and React/JavaScript
          config: >-
            auto
            p/python
            p/flask
            p/react
            p/javascript
            p/typescript
            p/docker
            p/aws
            p/secrets
            p/owasp-top-ten
            p/security-audit
          # Generate SARIF output for GitHub Security tab integration
          generateSarif: "1"
          
        env:
          # Semgrep App token for advanced features (optional)
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Upload SARIF file to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: semgrep.sarif
          
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('semgrep.sarif')) {
              const sarif = JSON.parse(fs.readFileSync('semgrep.sarif', 'utf8'));
              const results = sarif.runs[0].results || [];
              
              if (results.length > 0) {
                let comment = '## üîí SAST Security Scan Results\n\n';
                comment += `Found ${results.length} potential security issue(s):\n\n`;
                
                const highSeverity = results.filter(r => r.level === 'error').length;
                const mediumSeverity = results.filter(r => r.level === 'warning').length;
                const lowSeverity = results.filter(r => r.level === 'note').length;
                
                if (highSeverity > 0) comment += `- üö® **${highSeverity}** high severity\n`;
                if (mediumSeverity > 0) comment += `- ‚ö†Ô∏è **${mediumSeverity}** medium severity\n`;
                if (lowSeverity > 0) comment += `- üìù **${lowSeverity}** low severity\n`;
                
                comment += '\nüìã Review the **Security** tab for detailed findings and remediation guidance.';
                
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            }

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript-typescript', 'python' ]
        
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          # Use default query suite + security-and-quality queries
          queries: security-and-quality

      - name: Setup Node.js for JavaScript analysis
        if: matrix.language == 'javascript-typescript'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install frontend dependencies
        if: matrix.language == 'javascript-typescript'
        working-directory: frontend
        run: npm ci

      - name: Setup Python for Python analysis
        if: matrix.language == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install Python dependencies
        if: matrix.language == 'python'
        working-directory: backend/api/src/main/python
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{matrix.language}}"